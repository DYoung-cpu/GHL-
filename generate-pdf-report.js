/**
 * Generate PDF Report for Paul Tropp Leads
 */

const PDFDocument = require('pdfkit');
const fs = require('fs');

const doc = new PDFDocument({ margin: 50 });
const outputPath = '/mnt/c/Users/dyoun/Downloads/Paul-Tropp-Leads-Report.pdf';
doc.pipe(fs.createWriteStream(outputPath));

// Helper functions
function drawTitle(text) {
  doc.fontSize(24).fillColor('#2c3e50').text(text, { align: 'center' });
  doc.moveDown(0.5);
  doc.strokeColor('#3498db').lineWidth(2)
    .moveTo(50, doc.y).lineTo(550, doc.y).stroke();
  doc.moveDown();
}

function drawSection(title) {
  doc.moveDown();
  doc.fontSize(16).fillColor('#34495e').text(title);
  doc.strokeColor('#bdc3c7').lineWidth(1)
    .moveTo(50, doc.y + 2).lineTo(400, doc.y + 2).stroke();
  doc.moveDown(0.5);
}

function drawTable(headers, rows, colWidths) {
  const startX = 50;
  let y = doc.y;
  const rowHeight = 22;

  // Headers
  doc.fillColor('#3498db').rect(startX, y, colWidths.reduce((a,b) => a+b, 0), rowHeight).fill();
  doc.fillColor('white').fontSize(10);
  let x = startX;
  headers.forEach((h, i) => {
    doc.text(h, x + 5, y + 6, { width: colWidths[i] - 10 });
    x += colWidths[i];
  });
  y += rowHeight;

  // Rows
  rows.forEach((row, rowIndex) => {
    if (rowIndex % 2 === 0) {
      doc.fillColor('#f9f9f9').rect(startX, y, colWidths.reduce((a,b) => a+b, 0), rowHeight).fill();
    }
    doc.fillColor('#333').fontSize(9);
    x = startX;
    row.forEach((cell, i) => {
      doc.text(String(cell), x + 5, y + 6, { width: colWidths[i] - 10 });
      x += colWidths[i];
    });
    y += rowHeight;
  });

  doc.y = y + 10;
}

function formatNum(n) {
  return n.toLocaleString();
}

// Report Data
const data = {
  total: 606131,
  categories: [
    ['Realtor', 211691, '34.9%'],
    ['Personal Email (Unknown)', 386006, '63.7%'],
    ['Lender', 5437, '0.9%'],
    ['Attorney', 1168, '0.2%'],
    ['Title/Escrow', 557, '0.1%'],
    ['Builder/Developer', 528, '0.1%'],
    ['Insurance', 372, '0.1%'],
    ['Appraiser', 372, '0.1%']
  ],
  realtorsByState: [
    ['California (CA)', 57840, '27.3%'],
    ['Florida (FL)', 21822, '10.3%'],
    ['Texas (TX)', 17831, '8.4%'],
    ['Arizona (AZ)', 10287, '4.9%'],
    ['Nevada (NV)', 5397, '2.5%'],
    ['No State (AdRoll)', 98514, '46.5%']
  ],
  nameQuality: [
    ['High Confidence (firstname.lastname)', 64258, '10.6%'],
    ['Medium Confidence (patterns)', 46318, '7.6%'],
    ['State Files (real names)', 205464, '33.9%'],
    ['AdRoll (potentially fake names)', 290091, '47.9%']
  ]
};

// Generate PDF
doc.fillColor('#333');

// Title
drawTitle('Paul Tropp Leads Analysis Report');
doc.fontSize(10).fillColor('#666').text(`Generated: ${new Date().toLocaleString()}`, { align: 'center' });
doc.moveDown(2);

// Summary Box
doc.fillColor('#ecf0f1').rect(50, doc.y, 500, 60).fill();
doc.fillColor('#2980b9').fontSize(36).text(formatNum(data.total), 50, doc.y - 50, { width: 500, align: 'center' });
doc.fillColor('#333').fontSize(12).text('Total Contacts in Database', { align: 'center' });
doc.moveDown(2);

// By Category
drawSection('Breakdown by Category');
drawTable(
  ['Category', 'Count', 'Percentage'],
  data.categories.map(r => [r[0], formatNum(r[1]), r[2]]),
  [250, 120, 100]
);

// Realtors by State
drawSection('Realtors by State (211,691 total)');
drawTable(
  ['State', 'Count', '% of Realtors'],
  data.realtorsByState.map(r => [r[0], formatNum(r[1]), r[2]]),
  [250, 120, 100]
);

// New Page
doc.addPage();

// Name Quality
drawSection('Name Quality Analysis');
drawTable(
  ['Quality Level', 'Count', 'Percentage'],
  data.nameQuality.map(r => [r[0], formatNum(r[1]), r[2]]),
  [280, 100, 90]
);

// Warning Box
doc.moveDown();
doc.fillColor('#fff3cd').rect(50, doc.y, 500, 80).fill();
doc.fillColor('#856404').fontSize(14).text('⚠️ Contacts with Potentially Mismatched Names', 60, doc.y - 70);
doc.fontSize(28).text('290,091', 60, doc.y - 50);
doc.fontSize(10).text('47.9% of contacts have AdRoll names that may not match email addresses.', 60, doc.y - 25);
doc.fontSize(9).text('These names were scraped from ads and don\'t correspond to actual email owners.', 60, doc.y - 10);
doc.moveDown(4);

// Summary
drawSection('Summary');
doc.fontSize(11).fillColor('#333');
doc.list([
  `Identified Professionals: ${formatNum(220125)} (36.3%)`,
  `Personal Emails (Unknown profession): ${formatNum(386006)} (63.7%)`,
  `Realtors with State Data: ${formatNum(113177)} contacts`,
  `Names Successfully Parsed from Email: ${formatNum(110576)} contacts`,
  `Names That May Be Incorrect: ${formatNum(290091)} contacts (AdRoll data with fake names)`
], { bulletRadius: 2, textIndent: 20 });

// Footer
doc.moveDown(2);
doc.fontSize(9).fillColor('#7f8c8d');
doc.text('Report generated by GHL Automation System', { align: 'center' });
doc.text('Data source: Paul Tropp AdRoll leads + State-specific realtor lists', { align: 'center' });

doc.end();

console.log('PDF Report generated: ' + outputPath);
